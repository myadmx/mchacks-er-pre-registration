<!DOCTYPE html>
<html>
<head>
    <title>ER Pre-Registration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="page-bg">

<header class="header">
    <img src="/static/chum-logo.png" alt="CHUM Hospital" class="logo">
    <h1>CHUM Hospital</h1>
</header>

<section class="hero">
    <h2>Emergency Room Pre-Registration</h2>
    <p>Save time at the emergency room by pre-registering online.</p>
</section>

<main class="card">

<form action="/submit" method="POST">

    <label>Full Name:</label><br>
    <input type="text" name="name" required><br><br>

    <label for="sex">Sex</label>
    <select name="sex" id="sex" required>
        <option value="" disabled selected>Select an option</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Prefer not to say">Prefer not to say</option>
    </select><br><br>


    <label>Medical Card Number:</label><br>
    <input 
        type="text" 
        name="medical_card" 
        id="medicalCard"
        oninput="validateMedicalCard()"
        required>

    <div id="cardError" style="color:red; font-size:12px; display:none;">
        No spaces allowed.
    </div>
    <br><br>


    <label>Phone Number:</label><br>
    <input 
        type="tel" 
        name="phone_number"
        id="phoneNumber"
        placeholder="e.g. 5141234567"
        oninput="validatePhoneNumber()"
        required>

    <div id="phoneError" style="color:red; font-size:12px; display:none;">
        Enter a valid phone number (digits only).
    </div>
    <br><br>



    <label>Age Range:</label><br>
    <select name="age_range">
        <option value="0-6">0‚Äì6</option>
        <option value="7-12">7-12</option>
        <option value="13-17">13‚Äì17</option>
        <option value="18-25">18‚Äì25</option>
        <option value="26-40">26‚Äì40</option>
        <option value="41-60">41‚Äì60</option>
        <option value="60+">60+</option>
    </select><br><br>

    <label>Symptoms:</label><br>
    <div class="symptom-grid">

    <div class="symptom-box">
        <input type="checkbox" onclick="toggleSub(this, 'fever')"> Fever / feeling sick
        <div id="fever" class="sub-symptoms">
            <input type="checkbox" name="subsymptoms" value="fever"> Fever<br>
            <input type="checkbox" name="subsymptoms" value="chills"> Chills<br>
            <input type="checkbox" name="subsymptoms" value="flu"> Flu-like illness
        </div>
    </div>

    <div class="symptom-box">
        <input type="checkbox" onclick="toggleSub(this,'injury')"> Injury or trauma
        <span class="camera-icon" onclick="openCamera()">üì∑</span>
        <div id="injury" class="sub-symptoms">
            <input type="checkbox" name="subsymptoms" value="sprain"> Sprains<br>
            <input type="checkbox" name="subsymptoms" value="cut"> Cuts<br>
            <input type="checkbox" name="subsymptoms" value="burn"> Burns<br>
            <input type="checkbox" name="subsymptoms" value="dislocation"> Dislocations<br>
            <input type="checkbox" name="subsymptoms" value="fracture"> Fractures
        </div>
    </div>

    <div class="symptom-box">
        <input type="checkbox" onclick="toggleSub(this,'chest')"> Chest pain or discomfort
        <div id="chest" class="sub-symptoms">
            <input type="checkbox" name="subsymptoms" value="pressure"> Pressure<br>
            <input type="checkbox" name="subsymptoms" value="tightness"> Tightness<br>
            <input type="checkbox" name="subsymptoms" value="pain"> Pain
        </div>
    </div>

    <div class="symptom-box">
        <input type="checkbox" onclick="toggleSub(this,'breathing')"> Breathing problems
        <div id="breathing" class="sub-symptoms">
            <input type="checkbox" name="subsymptoms" value="shortness"> Shortness of breath<br>
            <input type="checkbox" name="subsymptoms" value="wheezing"> Wheezing<br>
            <input type="checkbox" name="subsymptoms" value="trouble"> Trouble breathing
        </div>
    </div>

    <div class="symptom-box">
        <input type="checkbox" onclick="toggleSub(this,'stomach')"> Stomach / digestive
        <div id="stomach" class="sub-symptoms">
            <input type="checkbox" name="subsymptoms" value="abdominal"> Abdominal pain<br>
            <input type="checkbox" name="subsymptoms" value="nausea"> Nausea<br>
            <input type="checkbox" name="subsymptoms" value="vomiting"> Vomiting<br>
            <input type="checkbox" name="subsymptoms" value="diarrhea"> Diarrhea
        </div>
    </div>
    <!-- SECOND ROW OF SYMPTOMS -->

    <div class="symptom-box">
        <input type="checkbox" onclick="toggleSub(this,'neuro')"> Head or neurological symptoms
        <div id="neuro" class="sub-symptoms">
            <input type="checkbox" name="subsymptoms" value="headache"> Headache<br>
            <input type="checkbox" name="subsymptoms" value="dizziness"> Dizziness<br>
            <input type="checkbox" name="subsymptoms" value="fainting"> Fainting<br>
            <input type="checkbox" name="subsymptoms" value="numbness"> Numbness
        </div>
    </div>

    <div class="symptom-box">
        <input type="checkbox" onclick="toggleSub(this, 'skin')"> Skin problems
        <span class="camera-icon" onclick="openCamera()">üì∑</span>
        <div id="skin" class="sub-symptoms">
            <input type="checkbox" name="subsymptoms" value="rash"> Rash<br>
            <input type="checkbox" name="subsymptoms" value="swelling"> Swelling<br>
            <input type="checkbox" name="subsymptoms" value="infection"> Infection
        </div>
    </div>

    <div class="symptom-box">
        <input type="checkbox" onclick="toggleSub(this, 'bleeding')"> Bleeding or wounds
        <span class="camera-icon" onclick="openCamera()">üì∑</span>
        <div id="bleeding" class="sub-symptoms">
            <input type="checkbox" name="subsymptoms" value="cuts"> Cuts<br>
            <input type="checkbox" name="subsymptoms" value="nosebleeds"> Nosebleeds<br>
            <input type="checkbox" name="subsymptoms" value="uncontrolled"> Uncontrolled bleeding
        </div>
    </div>

    <div class="symptom-box">
        <input type="checkbox" onclick="toggleSub(this, 'mental')"> Mental or emotional distress
        <div id="mental" class="sub-symptoms">
            <input type="checkbox" name="subsymptoms" value="anxiety"> Anxiety<br>
            <input type="checkbox" name="subsymptoms" value="panic"> Panic<br>
            <input type="checkbox" name="subsymptoms" value="unwell"> Feeling unwell / ‚Äúnot right‚Äù
        </div>
    </div>

    <div class="symptom-box">
        <input type="checkbox" onclick="toggleSub(this,'allergic')"> Allergic reaction
        <div id="allergic" class="sub-symptoms">
            <input type="checkbox" name="subsymptoms" value="skin_reaction"> Skin problems<br>
            <input type="checkbox" name="subsymptoms" value="dizziness"> Dizziness<br>
            <input type="checkbox" name="subsymptoms" value="nausea"> Nausea<br>
            <input type="checkbox" name="subsymptoms" value="breathing"> Breathing problems
        </div>
    </div>

</div>

<!-- Camera + Photos Layout -->
<div id="cameraPhotoWrapper">

    <!-- Camera -->
    <div id="cameraSection" style="display:none;">
        <video id="video" width="300" autoplay></video><br><br>
        <button type="button" onclick="takePhoto()">Take Photo</button>
        <button type="button" onclick="closeCamera()">Close Camera</button>
        <canvas id="canvas" width="300" height="225" style="display:none;"></canvas>
    </div>

    <!-- Photos -->
    <div id="photoSection">
        <p><strong>Captured Images:</strong></p>
        <div id="photoContainer"></div>
    </div>

</div>

<input type="hidden" name="captured_images" id="capturedImages">
<br>



    <label>Additional information:</label><br>
    <textarea name="information_text" rows="4" cols="40"></textarea><br><br>

    <label>Diagnosed Conditions:</label><br>
    <div class="conditions-container">

        <button type="button" class="condition-btn" onclick="toggleCondition(this, 'diabetes_type_1')">
            Diabetes Type 1
        </button>

        <button type="button" class="condition-btn" onclick="toggleCondition(this, 'diabetes_type_2')">
            Diabetes Type 2
        </button>

        <button type="button" class="condition-btn" onclick="toggleCondition(this, 'diabetes_type_3')">
            Diabetes Type 3
        </button>

        <button type="button" class="condition-btn" onclick="toggleCondition(this, 'hypertension')">
            Hypertension
        </button>

        <button type="button" class="condition-btn" onclick="toggleCondition(this, 'uri')">
            Upper Respiratory Infection
        </button>

        <button type="button" class="condition-btn" onclick="toggleCondition(this, 'anxiety_depression')">
            Anxiety / Depression
        </button>

        <button type="button" class="condition-btn" onclick="toggleOtherConditions()">
            Other
        </button>

    </div>

    <input type="hidden" name="diagnosed_conditions" id="diagnosedConditions">

    <div id="otherConditionsBox" style="display:none; margin-top:8px;">
        <input 
            type="text" 
            name="other_conditions"
            placeholder="Please specify other diagnosed conditions"
            style="width:100%;">
    </div>

    <br><br>


    <h3>Estimated Time of Arrival</h3>
    <!-- Transport mode selector -->
    <label for="travelMode">Transport method:</label>
    <select id="travelMode">
        <option value="DRIVING">Driving</option>
        <option value="TRANSIT">Public Transit</option>
        <option value="WALKING">Walking</option>
        <option value="BICYCLING">Bicycling</option>
    </select>

    <br><br>

    <!-- Route selector -->
    <label for="routeOption">Route preference:</label>
    <select id="routeOption">
        <option value="BEST_GUESS">Best route</option>
        <option value="LESS_TRAFFIC">Less traffic</option>
    </select>

    <br><br>

    <!-- Map -->
    <div id="map" style="width:100%; height:350px; border-radius:8px;"></div>

    <br>

    <!-- Auto-filled ETA summary -->
    <div id="etaBox" style="border:1px solid #ccc; padding:10px; border-radius:6px;">
        <strong>ETA:</strong>
        <div id="etaText">Calculating...</div>
    </div>

    <!-- Hidden field to submit ETA -->
    <input type="hidden" name="eta_data" id="etaData">


    <br><br>
    <button type="submit">Submit</button>

</form>

</main>

<!-- Google Maps JavaScript API (PASTE HERE) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCzMVg8lBqxwC2d5TyPT7XIZZlyGjEQrvc"></script>



<script>
function toggleSub(checkbox, id) {
    const div = document.getElementById(id);
    div.style.display = checkbox.checked ? "block" : "none";
}

let videoStream;

function openCamera() {
    const cameraSection = document.getElementById("cameraSection");
    cameraSection.style.display = "block";

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            videoStream = stream;
            document.getElementById("video").srcObject = stream;
        })
        .catch(err => {
            alert("Camera access denied or unavailable.");
        });
}

let capturedImages = [];

function takePhoto() {
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageData = canvas.toDataURL("image/png");

    // Store image
    capturedImages.push(imageData);
    updateHiddenInput();
    displayImages();
}



function displayImages() {
    const container = document.getElementById("photoContainer");
    container.innerHTML = "";

    capturedImages.forEach((img, index) => {
        const wrapper = document.createElement("div");
        wrapper.className = "photo-wrapper";
        wrapper.style.marginBottom = "15px"; 
        wrapper.style.textAlign = "center";

        const image = document.createElement("img");
        image.src = img;
        image.style.width = "150px";
        image.style.borderRadius = "8px";
        image.style.border = "1px solid #ccc";

        // --- THE AI BUTTON ---
        const analyzeBtn = document.createElement("button");
        analyzeBtn.type = "button";
        analyzeBtn.innerHTML = "üè• Check Severity (AI)";
        analyzeBtn.style.marginTop = "5px";
        analyzeBtn.style.backgroundColor = "#ff9800"; // Orange
        analyzeBtn.style.color = "white";
        analyzeBtn.style.border = "none";
        analyzeBtn.style.padding = "5px 10px";
        analyzeBtn.style.cursor = "pointer";
        analyzeBtn.style.borderRadius = "4px";
        analyzeBtn.style.fontSize = "12px";
        
        // When clicked, run the AI function
        analyzeBtn.onclick = () => runAIAnalysis(img, analyzeBtn);

        // DELETE BUTTON
        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.textContent = "Remove";
        deleteBtn.style.marginTop = "5px";
        deleteBtn.style.marginLeft = "5px";
        deleteBtn.style.fontSize = "12px";
        deleteBtn.onclick = () => deletePhoto(index);

        wrapper.appendChild(image);
        wrapper.appendChild(document.createElement("br")); // New line
        wrapper.appendChild(analyzeBtn);
        wrapper.appendChild(deleteBtn);
        container.appendChild(wrapper);
    });
}

// --- ADD THIS NEW FUNCTION BELOW displayImages ---

function runAIAnalysis(base64Image, btnElement) {
    // 1. Change button text to show it's working
    const originalText = btnElement.innerHTML;
    btnElement.innerHTML = "‚è≥ Analyzing...";
    btnElement.disabled = true;

    // 2. Send to Python
    fetch("/analyze_injury", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ image: base64Image })
    })
    .then(response => response.json())
    .then(data => {
        // 3. Handle Result
        if (data.error) {
            alert("Error: " + data.error);
            btnElement.innerHTML = originalText;
            btnElement.disabled = false;
        } else {
            // Update the button with the result
            if (data.is_severe) {
                btnElement.innerHTML = "‚ö†Ô∏è SEVERE";
                btnElement.style.backgroundColor = "#d32f2f"; // Red
                alert(data.message + "\n\nConfidence: " + data.confidence);
            } else {
                btnElement.innerHTML = "‚úÖ MINOR";
                btnElement.style.backgroundColor = "#388e3c"; // Green
                alert(data.message + "\n\nConfidence: " + data.confidence);
            }
        }
    })
    .catch(err => {
        console.error(err);
        alert("Server connection failed.");
        btnElement.innerHTML = originalText;
        btnElement.disabled = false;
    });
}
    

function deletePhoto(index) {
    capturedImages.splice(index, 1);
    updateHiddenInput();
    displayImages();
}

function updateHiddenInput() {
    document.getElementById("capturedImages").value = JSON.stringify(capturedImages);
}



function closeCamera() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
    }
    document.getElementById("cameraSection").style.display = "none";
}



function validateMedicalCard() {
    const input = document.getElementById("medicalCard");
    const error = document.getElementById("cardError");

    if (input.value.includes(" ")) {
        input.classList.add("input-error");
        error.style.display = "block";
    } else {
        input.classList.remove("input-error");
        error.style.display = "none";
    }
}

function validatePhoneNumber() {
    const input = document.getElementById("phoneNumber");
    const error = document.getElementById("phoneError");

    // Allow digits only
    const digitsOnly = /^[0-9]{10,15}$/;

    if (!digitsOnly.test(input.value)) {
        input.classList.add("input-error");
        error.style.display = "block";
    } else {
        input.classList.remove("input-error");
        error.style.display = "none";
    }
}

let selectedConditions = [];

function toggleCondition(button, value) {
    if (selectedConditions.includes(value)) {
        selectedConditions = selectedConditions.filter(v => v !== value);
        button.classList.remove("active");
    } else {
        selectedConditions.push(value);
        button.classList.add("active");
    }

    document.getElementById("diagnosedConditions").value =
        JSON.stringify(selectedConditions);
}

function toggleOtherConditions() {
    const box = document.getElementById("otherConditionsBox");
    box.style.display = box.style.display === "none" ? "block" : "none";
}

let map, directionsService, directionsRenderer;
const CHUM_LOCATION = { lat: 45.5088, lng: -73.554 };

function initMap() {
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer();

    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: CHUM_LOCATION
    });

    directionsRenderer.setMap(map);

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                const userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                calculateRoute(userLocation);
                document.getElementById("travelMode").addEventListener("change", () => calculateRoute(userLocation));
                document.getElementById("routeOption").addEventListener("change", () => calculateRoute(userLocation));
            },
            () => {
                document.getElementById("etaText").innerText =
                    "Location access denied. Unable to calculate ETA.";
            }
        );
    } else {
        document.getElementById("etaText").innerText =
            "Geolocation not supported.";
    }
}

function calculateRoute(origin) {
    const mode = document.getElementById("travelMode").value;
    const routePref = document.getElementById("routeOption").value;

    directionsService.route(
        {
            origin: origin,
            destination: CHUM_LOCATION,
            travelMode: google.maps.TravelMode[mode],
            drivingOptions: {
                departureTime: new Date(),
                trafficModel:
                    routePref === "LESS_TRAFFIC" ? "pessimistic" : "bestguess"
            }
        },
        (result, status) => {
            if (status === "OK") {
                directionsRenderer.setDirections(result);

                const leg = result.routes[0].legs[0];
                const etaText =
                    `${leg.duration.text} (${leg.distance.text})`;

                document.getElementById("etaText").innerText = etaText;
                document.getElementById("etaData").value =
                    `Mode: ${mode}, ETA: ${etaText}`;
            }
        }
    );
}

/* AUTO LOAD MAP ON PAGE OPEN */
window.onload = initMap;

</script>


</body>
</html>
